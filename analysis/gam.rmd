---
title: "GAM modelling"
author: "Euan Enticott"
date: "17/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = paste0(rprojroot::find_rstudio_root_file(), "/chigcrim"))
```

## Imports

```{r}
# Load required packages
library(mgcv)
library(tidyverse)
library(lubridate)
library(spatstat)
devtools::load_all()
```

## Data

For the training data we will use historical data from 2016 - 2018. We will then predict on the data from 2019 to test the model.
```{r, cache = TRUE}
# Downoad training data
crime_train <- load_data(c(2015, 2018), strings_as_factors = TRUE)
# Download test data
crime_test <- load_data(2019, strings_as_factors = TRUE)

# Need 2014 data to fill in missing value for n_pre in 2015 data
data_2014 <- load_data(2014, strings_as_factors = TRUE)
data_2014 <- data_2014 %>% convert_dates(exclude = "hour") %>% count(year, date) %>% arrange(year)

```

It is then necessary to prepare the data for its' use within the Generalised Additive Models. 

```{r}
# Extract useful information from the date
crime_train %<>% convert_dates(exclude = "hour")
crime_test %<>% convert_dates(exclude = "hour")


# List of features to use in GAM
keep_features <- c("month", "week", "year", "day", "date", "community_area", 
                   "beat", "fbi_code", "yday")

# Prep data for use in GAM
# Use all_of(keep_features) to suppress warning message
gam_train <- crime_train %>% select(all_of(keep_features)) %>% na.omit() %>% 
  mutate(day = as.numeric(day))
gam_test <- crime_test %>% select(all_of(keep_features)) %>% na.omit() %>% 
  mutate(day = as.numeric(day))
```

We are interested in predicting the daily number of crimes, each row represents a crime thus we need to sum the rows for each day to get the number of crimes. We can use the `count` function to achieve this. Later we will look at breaking down the data further to predict how many of each type of crime (by FBI code) will occur in each commmunity area on a given day.

```{r}
# Quicker than aggregate
train_dat <- gam_train %>% count(yday, year, date) %>% arrange(year, yday)
test_dat <- gam_test %>% count(yday, year, date) %>% arrange(year, yday)
```

## Model creation

We now build the GAMs using the `mgcv` package.

```{r}
# Baseline GAM
gam1 <- gam(n ~ s(as.numeric(yday), bs = "cc") + year, data = train_dat, 
            family = "poisson")

# Store type of each data 
train_dat$Type <- "Training data"
test_dat$Type <- "Test data"
all_dat <- rbind(train_dat, test_dat)
all_dat$Type <- as.factor(all_dat$Type)

# Create plot for baseline model
base_gam_plot <- ggplot(all_dat) + geom_point(aes(date, n)) + xlab("Date") + ylab("Daily crimes") + geom_line(aes(date, predict(gam1, type = "response", newdata = all_dat), colour = Type), size = 2) + ggtitle("Baseline GAM") + theme(legend.position = c(0.9, 0.9), legend.background = element_rect(fill="lightgrey", size=0.5, linetype="solid"), legend.title = element_text(size = 13), legend.text = element_text(size = 10))

base_gam_plot

# Find accuracy
RMSE1 <- rmse_loss(predict(gam1, type = "response", newdata = test_dat), test_dat$n)
RMSE1

R2_1 <- r_squared(predict(gam1, type = "response", newdata = test_dat), test_dat$n)
R2_1

ggsave("../plots/base_gam_plot.pdf", plot = base_gam_plot, width = 9.99, height = 6.45, units = "in")

```

## Feature creation

There are several features that may be of interest, whether a day is a weekend or not, the number of crimes over the previous month, the number of crimes on the same day of the previous year. We make tables of the days with the least and most daily crimes.

```{r}
most_crimes <- train_dat %>% arrange(by = desc(n))
most_crimes$date <- as.character(most_crimes$date) #xtable doesn't handle date format
xtable(head(most_crimes[,-5]), )
```

```{r}
least_crimes <- train_dat %>% arrange(by = n)
least_crimes$date <- as.character(least_crimes$date) #xtable doesn't handle date format
xtable(head(least_crimes[,-5]), )
```

```{r}
add_prev_day <- function(dat, start_date) {
    dat$n_pre <- left_join(data.frame(date = dat$date - days(1)), dat, by = "date")$n
    dat$n_pre[is.na(dat$n_pre)] <- 0
    dat$n_pre[dat$date == start_date] <- NA
    return(dat)
}

add_prev_week <- function(dat, start_date) {
    dat$n_pre <- left_join(data.frame(date = dat$date - days(1)), dat, by = "date")$n
    dat$n_pre[is.na(dat$n_pre)] <- 0
    dat$n_pre[dat$date == start_date] <- NA
    return(dat)
}


add_dow <- function(dat) {
  dat$dow <- wday(dat$date)
  return(dat)
}

add_is_fom <- function(dat) {
  dat$is_fom <- mday(dat$date) == 1
  return(dat)
}

add_is_christmas <- function(dat) {
  dat$is_christmas <- format(dat$date, "%d-%m") == "25-12" | 
    format(dat$date, "%d-%m") == "24-12" |
    format(dat$date, "%d-%m") == "26-12"
  return(dat)
}

add_is_NYD <- function(dat) {
  dat$is_NYD <- format(dat$date, "%d-%m") == "01-01" 
  return(dat)
}

add_month <- function(dat) {
  dat$month <- month(dat$date)
  return(dat)
}

add_week <- function(dat) {
  dat$week <- week(dat$date)
  return(dat)
}



# Add features to train data
train_dat <- add_prev_day(train_dat, "2015-01-01")
train_dat <- add_dow(train_dat)
train_dat <- add_is_fom(train_dat)
train_dat <- add_is_christmas(train_dat)
train_dat <- add_is_NYD(train_dat)
train_dat <- add_month(train_dat)
train_dat <- add_week(train_dat)

# Use 2014 data to fill in missing value for n_pre in 2015 data
data_2014 <- load_data(2014, strings_as_factors = TRUE)
data_2014 <- data_2014 %>% convert_dates(exclude = "hour") %>% count(year, date) %>% arrange(year)

train_dat[1, "n_pre"] <- data_2014[data_2014$date == "2014-12-31", "n"][1,] #fill in previous year manually

# Add features to test data
test_dat <- add_prev_day(test_dat, "2019-01-01")
test_dat <- add_dow(test_dat)
test_dat <- add_is_fom(test_dat)
test_dat <- add_is_christmas(test_dat)
test_dat <- add_is_NYD(test_dat)
test_dat <- add_month(test_dat)
test_dat <- add_week(test_dat)
test_dat[1, "n_pre"] <- train_dat[train_dat$date == "2018-12-31", "n"] #fill in previous year manually

```

```{r}
gam2 <- gam(n ~ s(as.numeric(yday), bs = "cc") + n_pre, data = train_dat, family = "poisson")

gam_plot2 <- ggplot(all_dat) + geom_point(aes(date, n)) + xlab("Date") + ylab("Daily crimes") + geom_line(aes(date, predict(gam2, type = "response", newdata = all_dat), colour = Type), size = 2, alpha = 0.4) + ggtitle("Daily GAM") + theme(legend.position = c(0.9, 0.9), legend.background = element_rect(fill="lightgrey", size=0.5, linetype="solid"), legend.title = element_text(size = 13), legend.text = element_text(size = 10))

RMSE2 <- rmse_loss(predict(gam2, type = "response", newdata = test_dat), test_dat$n)
RMSE2

R2_2 <- r_squared(predict(gam2, type = "response", newdata = test_dat), test_dat$n)
R2_2

```

```{r}
gam3 <- gam(n ~ s(as.numeric(yday), bs = "cc") + s(as.numeric(dow), bs = "cr", k = 5) + n_pre, data = train_dat, family = "poisson")

gam_plot3 <- ggplot(all_dat) + geom_point(aes(date, n)) + xlab("Date") + ylab("Daily crimes") + geom_line(aes(date, predict(gam3, type = "response", newdata = all_dat), colour = Type), size = 2, alpha = 0.4) + ggtitle("Daily GAM") + theme(legend.position = c(0.9, 0.9), legend.background = element_rect(fill="lightgrey", size=0.5, linetype="solid"), legend.title = element_text(size = 13), legend.text = element_text(size = 10))
RMSE3 <- rmse_loss(predict(gam3, type = "response", newdata = test_dat), test_dat$n)
RMSE3

R2_3 <- r_squared(predict(gam3, type = "response", newdata = test_dat), test_dat$n)
R2_3


```
```{r}
gam4 <- gam(n ~ s(as.numeric(yday), bs = "cc") + as.factor(dow) + n_pre, data = train_dat, family = "poisson")

gam_plot4 <- ggplot(all_dat) + geom_point(aes(date, n)) + xlab("Date") + ylab("Daily crimes") + geom_line(aes(date, predict(gam4, type = "response", newdata = all_dat), colour = Type), size = 2, alpha = 0.4) + ggtitle("Daily GAM") + theme(legend.position = c(0.9, 0.9), legend.background = element_rect(fill="lightgrey", size=0.5, linetype="solid"), legend.title = element_text(size = 13), legend.text = element_text(size = 10))

RMSE4 <- rmse_loss(predict(gam4, type = "response", newdata = test_dat), test_dat$n)
RMSE4

R2_4 <- r_squared(predict(gam4, type = "response", newdata = test_dat), test_dat$n)
R2_4


```

```{r}
# Final daily GAM model
gam5 <- gam(n ~ s(as.numeric(yday), bs = "cc") + as.factor(dow) + n_pre + is_fom + is_christmas + 
               is_NYD + as.factor(week) , data = train_dat, family = "poisson")

best_gam_plot <- ggplot(all_dat) + geom_point(aes(date, n)) + xlab("Date") + ylab("Daily crimes") + geom_line(aes(date, predict(gam5, type = "response", newdata = all_dat), colour = Type), size = 2, alpha = 0.4) + ggtitle("Daily GAM") + theme(legend.position = c(0.9, 0.9), legend.background = element_rect(fill="lightgrey", size=0.5, linetype="solid"), legend.title = element_text(size = 13), legend.text = element_text(size = 10))


RMSE5 <- rmse_loss(predict(gam5, type = "response", newdata = test_dat), test_dat$n)
RMSE5

R2_5 <- r_squared(predict(gam5, type = "response", newdata = test_dat), test_dat$n)
R2_5

plot(predict(gam5, type = "response", newdata = test_dat), test_dat$n)
abline(b = 1, a = 0, col = "red")

gam_metrics <- data.frame(RMSE = c(RMSE1, RMSE2, RMSE3, RMSE4, RMSE5), R2 = c(R2_1, R2_2, R2_3, R2_4, R2_5))

xtable(gam_metrics)

ggsave("../plots/best_gam_plot.pdf", plot = best_gam_plot, width = 9.99, height = 6.45, units = "in")
```

# Discrete Spatial Data

```{r, cache = TRUE, warning = FALSE, eval = F, echo = T}
# Construct training data set
spatial_train <- gam_train %>% 
  mutate(community_area = factor(community_area)) %>%
  count(month, year, community_area, fbi_code) %>%
  arrange(year, month, community_area)

# Construct test data set
spatial_test <- gam_test %>% 
  mutate(community_area = factor(community_area)) %>%
  count(month, year, community_area, fbi_code) %>%
  arrange(year, month, community_area)

# Train GAM
wGAM_com <- PoissonGAM$new(time_period = "month", region = "community_area",
                     crime_type = "fbi_code", include_nb = FALSE)

metrics <- list(rmse_loss, r_squared)

# Fit using gam_train as the dataset 
X <- spatial_train %>% select(-n)
y <- spatial_train$n

# Find CV error for given metrics
GAM_results <- kfold_cv(wGAM_com, X =X, y = y, error_funcs = metrics, k = 5, n_reps = 5, parallel = TRUE, n_threads = 5)
names(GAM_results) <- c("Root MSE", "R2")
xtable(as_tibble(GAM_results), digits = 4)

# Fit model and find validation error
wGAM_com$fit(X, y, n_threads = 7)
wGAM_com$gam_fitted
wGAM_com$fit_summary


spatial_test$predicted <- predict(wGAM_com$gam_fitted, type = "response", newdata = spatial_test)

val_rmse <- rmse_loss(spatial_test$n, spatial_test$predicted)
val_r2 <- r_squared(spatial_test$n, spatial_test$predicted)

val_rmse 
val_r2


com_area <- spatial_test %>% group_by(community_area) %>% summarise(n = sum(n), n_pred = sum(predicted))
com_area$residual <- (com_area$n - com_area$n_pred)
com_bounds$residual <- com_area$residual

by_area <- ggplot(com_bounds) + geom_sf(aes(fill = residual, text = community)) + 
  ggtitle("Predicted Crime frequency by community area") +
  colorspace::scale_fill_continuous_sequential(5, palette = "Inferno") + theme_void() +
  guides(fill = guide_colorbar(title = "Frequency")) +
  scale_fill_gradientn(colors = colorspace::sequential_hcl(5, palette = "Inferno")[5:1], 
                       breaks = seq(-1500, 1000, 500), limits = c(-1500, 1000))

by_area
ggsave("../plots/by_area.pdf", by_area)

```

```{r}

```
