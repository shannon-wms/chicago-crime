---
title: "GAM modelling"
author: "Euan Enticott"
date: "17/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Imports

```{r}
library(mgcv)
library(tidyverse)
library(lubridate)
library(spatstat)
devtools::load_all("../chigcrim/")
```

## Data

For the training data we will use historical data from 2016 - 2018. We will then predict on the data from 2019 to test the model.
```{r}
# Load training data
crime_2016 <- load_data(2016)
crime_2017 <- load_data(2017)
crime_2018 <- load_data(2018)

crime_train <- rbind(crime_2016, crime_2017, crime_2018)

```

```{r}
# Load test data
crime_2019 <- load_data(2019)

crime_test <- crime_2019
```

It is then necessary to prepare the data for its' use within the Generalised Additive Models. 

```{r}
# Extract useful information from the date
crime_train <- crime_train %>%
  mutate(month = factor(month(ymd_hms(date, tz = "GMT"))),
         day = factor(day(ymd_hms(date, tz = "GMT"))),
         hour = factor(hour(ymd_hms(date, tz = "GMT"))),
         yday = (yday(ymd_hms(date))),
         date = date(ymd_hms(date))) 

crime_test <- crime_test %>%
  mutate(month = factor(month(ymd_hms(date, tz = "GMT"))),
         day = factor(day(ymd_hms(date, tz = "GMT"))),
         hour = factor(hour(ymd_hms(date, tz = "GMT"))),
         yday = (yday(ymd_hms(date))),
         date = date(ymd_hms(date))) 


# List of features to use in GAM
keep_features <- c("month", "year", "day","date", "community_area", "fbi_code", "yday")

# Prep data for use in GAM
crime_train <- crime_train %>% select(keep_features) %>% na.omit(crime_dat) %>% 
  mutate(fbi_code = as.factor(fbi_code)) %>% mutate(community_area = as.factor(community_area)) %>%
  mutate(day = as.numeric(day))

crime_test <- crime_test %>% select(keep_features) %>% na.omit(crime_dat) %>% 
  mutate(fbi_code = as.factor(fbi_code)) %>% mutate(community_area = as.factor(community_area)) %>%
  mutate(day = as.numeric(day))

crime_train
```

We are interested in predicting the daily number of crimes, each row represents a crime thus we need to sum the rows for each day to get the number of crimes. We can use the `aggregate` function to achieve this. Later we will look at breaking down the data further to predict how many of each type of crime (by FBI code) will occur in each commmunity area on a given day.

```{r}
crime_train$n <- rep(1, nrow(crime_train))
crime_test$n <- rep(1, nrow(crime_test))

train_dat <- aggregate(n ~ yday + year + date, sum, data = crime_train)

test_dat <-  aggregate(n ~ yday + year + date, sum, data = crime_test)
```

## Model creation

We now build the GAMs using the `mgcv` package.

```{r}
gam1 <- gam(n ~ s(as.numeric(yday), bs = "cc")  + year, data = train_dat, family = "poisson")
plot(train_dat$n, predict(gam1, type = "response"))
abline(a = 0, b = 1, col = "red")

plot(train_dat$date, train_dat$n)
points(train_dat$date, predict(gam1, type = "response"), col = "red")

all_dat <- rbind(train_dat, test_dat)
plot(all_dat$date, all_dat$n, xlab = "Date", ylab = "Daily crimes")
points(all_dat$date, predict(gam1, type = "response", newdata = all_dat), col = c(rep("red", nrow(train_dat)), rep("blue", nrow(test_dat))))
abline(v = date("2019-01-01"), lty = "dashed")
```

## Feature creation
There are several features that may be of interest, whether a day is a weekend or not, the number of crimes over the previous month, the number of crimes on the same day of the previous year. 

```{r}
add_prev_day <- function(dat, start_date) {
    dat$n_pre <- left_join(data.frame(date = dat$date - days(1)), dat, by = "date")$n
    dat$n_pre[is.na(dat$n_pre)] <- 0
    dat$n_pre[dat$date == start_date] <- NA
    return(dat)
}

add_prev_week <- function(dat, start_date) {
    dat$n_pre <- left_join(data.frame(date = dat$date - days(1)), dat, by = "date")$n
    dat$n_pre[is.na(dat$n_pre)] <- 0
    dat$n_pre[dat$date == start_date] <- NA
    return(dat)
}


add_dow <- function(dat) {
  dat$dow <- wday(dat$date)
  return(dat)
}

add_is_fom <- function(dat) {
  dat$is_fom <- mday(dat$date) == 1
  return(dat)
}

add_is_christmas <- function(dat) {
  dat$is_christmas <- format(dat$date, "%d-%m") == "25-12" | 
    format(dat$date, "%d-%m") == "24-12" |
    format(dat$date, "%d-%m") == "26-12"
  return(dat)
}

add_is_NYD <- function(dat) {
  dat$is_NYD <- format(dat$date, "%d-%m") == "01-01" 
  return(dat)
}

add_month <- function(dat) {
  dat$month <- month(dat$date)
  return(dat)
}

add_is_jan <- function(dat) {
  dat$is_jan <- month(dat$date) == 1
  return(dat)
}

add_week <- function(dat) {
  dat$week <- week(dat$date)
  return(dat)
}

train_dat <- add_prev_day(train_dat, "2016-01-01")
train_dat <- add_dow(train_dat)
train_dat <- add_is_fom(train_dat)
train_dat <- add_is_christmas(train_dat)
train_dat <- add_is_NYD(train_dat)
train_dat <- add_month(train_dat)
train_dat <- add_is_jan(train_dat)
train_dat <- add_week(train_dat)
```

```{r}
gam2 <- gam(n ~ s(as.numeric(yday), bs = "cc") + n_pre, data = train_dat, family = "poisson")
plot(train_dat$date, train_dat$n, xlim = c(date("2016-02-01"), date("2016-02-28")))
points(train_dat$date[-1], predict(gam2, type = "response"), col = "red")
plot(train_dat$date, train_dat$n)
points(train_dat$date[-1], predict(gam2, type = "response"), col = "red")

```

```{r}
gam3 <- gam(n ~ s(as.numeric(yday), bs = "cc") + s(as.numeric(dow), bs = "cr", k = 5) + n_pre, data = train_dat, family = "poisson")
plot(train_dat$date, train_dat$n, xlim = c(date("2016-02-01"), date("2016-02-28")))
points(train_dat$date[-1], predict(gam3, type = "response"), col = "red")
plot(train_dat$date, train_dat$n)
points(train_dat$date[-1], predict(gam3, type = "response"), col = "red")
```
```{r}
gam4 <- gam(n ~ s(as.numeric(yday), bs = "cc") + as.factor(dow) + n_pre, data = train_dat, family = "poisson")
plot(train_dat$date, train_dat$n, xlim = c(date("2017-12-01"), date("2018-02-28")))
points(train_dat$date[-1], predict(gam4, type = "response"), col = "red")
plot(train_dat$date, train_dat$n)
points(train_dat$date[-1], predict(gam4, type = "response"), col = "red")
```

```{r}
gam5 <- gam(n ~ s(as.numeric(yday), bs = "cc") + as.factor(dow) + n_pre + is_fom + is_christmas + 
              is_jan + is_NYD + as.factor(week), data = train_dat, family = "poisson")
plot(train_dat$date, train_dat$n, xlim = c(date("2016-02-01"), date("2016-02-28")))
points(train_dat$date[-1], predict(gam5, type = "response"), col = "red")
plot(train_dat$date, train_dat$n)
points(train_dat$date[-1], predict(gam5, type = "response"), col = "red")
plot(train_dat$date[-1], train_dat$n[-1] - predict(gam5, type = "response"))
```