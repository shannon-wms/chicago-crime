---
title: "Spatial summaries with ggplot"
author: "Shannon Williams"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Importing data and packages

```{r, message = FALSE}
library(sf)
library(raster)
library(tidyverse)
library(magrittr)
# Read crime data to tibble
Crime_2019 <- read_csv("data/crime-2019.csv", 
                       col_types = list(ID = col_integer(),
                                        `Case Number` = col_character(),
                                        Date = col_datetime(format = "%m/%d/%Y %H:%M:%S %p"),
                                        Block = col_factor(),
                                        IUCR = col_factor(),
                                        `Primary Type` = col_factor(),
                                        Description = col_factor(),
                                        `Location Description` = col_factor(),
                                        Arrest = col_logical(),
                                        Domestic = col_logical(),
                                        Beat = col_factor(),
                                        District = col_factor(),
                                        Ward = col_integer(),
                                        `Community Area` = col_integer(),
                                        `X Coordinate` = col_double(),
                                        `Y Coordinate` = col_double(),
                                        Year = col_integer(),
                                        `Updated On` = col_datetime(format = "%m/%d/%Y %H:%M:%S %p"),
                                        Latitude = col_double(),
                                        Longitude = col_double(),
                                        Location = col_character()))
Crime_NA <- na.omit(Crime_2019) %>% tibble()
Crime_2019
colnames(Crime_NA) %<>% strsplit(split = " ") %>% lapply(paste, collapse = "")
head(Crime_NA)

# Load shapefile containing community areas
com_bounds <- st_read("data/community_areas.shp", quiet = TRUE)
com_bounds %<>% arrange(as.integer(area_numbe))
print(com_bounds, n = 3)
plot(st_geometry(com_bounds))
```

Area numbers in `com_bounds` correspond to `CommunityArea` in `Crime_NA`, making plotting maps easier.

```{r}
Crime_summary <- Crime_NA %>% select(CommunityArea) %>% table() %>% as.data.frame()
colnames(Crime_summary) <- c("CommunityArea", "Freq")
head(Crime_summary)
com_bounds$crime_summary <- Crime_summary$Freq
plot(com_bounds["crime_summary"], main = "Crime frequency by community area")
```

The map is less detailed as it only includes community areas, but its construction is easier and doesn't require longitude and latitude coordinates (which are often missing).

Use `geom_sf` to make a `ggplot`. More details at: https://r-spatial.github.io/sf/articles/sf5.html and https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html

For colours I like to use **colorspace**: https://cran.r-project.org/web/packages/colorspace/vignettes/colorspace.html

```{r, message = FALSE, warning = FALSE}
p <- ggplot(com_bounds) + geom_sf(aes(fill = crime_summary, text = community)) + 
  ggtitle("Crime frequency by community area") +
  colorspace::scale_fill_continuous_sequential(5, palette = "Inferno") + theme_void() +
  guides(fill = guide_colorbar(title = "Frequency")) +
  scale_fill_gradientn(colors = colorspace::sequential_hcl(5, palette = "Inferno")[5:1], 
                       breaks = seq(0, 15000, 2500), limits = c(0, 15000))
p
```

Trying out interactive plots with **plotly**.

```{r, message = FALSE}
library(plotly)
p %>% ggplotly(tooltip = "text") %>% style(hoverlabel = list(bgcolor = "white"), hoveron = "fill")
```

Can use google map backgrounds with plotly and ggplot2.
```{r, message = FALSE}
library(ggmap)

register_google(key = "AIzaSyAv2lYIQ4Iw-Qu4bDPFsGB-Rdosvr_U208")

map_centre <- as.data.frame(geocode("chicago"))

basemap <- get_map(location=c(lon = map_centre$lon, lat = map_centre$lat), zoom=11)

p <- ggmap(basemap) + geom_sf(data = com_bounds, aes(fill = crime_summary, text = community, alpha = 0.3), inherit.aes = F) + 
  ggtitle("Crime frequency by community area") +
  colorspace::scale_fill_continuous_sequential(5, palette = "Inferno") + theme_void() +
  guides(fill = guide_colorbar(title = "Frequency")) +
  scale_fill_gradientn(colors = colorspace::sequential_hcl(5, palette = "Inferno")[5:1], 
                       breaks = seq(0, 15000, 2500), limits = c(0, 15000))

p %>% ggplotly(tooltip = "text") %>% style(hoverlabel = list(bgcolor = "white"), hoveron = "fill")
```

Or instead can create interactive maps using `leaflet` package (but as far as I know doesn't work with plotly).

```{r, message = FALSE}
library(leaflet)

leaflet(com_bounds) %>% addTiles() %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.4,
              fillColor = ~colorNumeric("inferno", crime_summary, reverse = T)(crime_summary),
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                  bringToFront = TRUE)) %>% addLegend(pal  = colorNumeric("inferno", com_bounds$crime_summary, reverse = T), values = ~com_bounds$crime_summary, title = "Crimes") 

```
